# 广告请求竞价流程

## 1. 前端发起广告填充请求

### 1.1 SDK 初始化
```java
// 在 Application 中初始化 SDK
public class MyApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
        AdServerClient.getInstance().init(this, "your_app_id", "your_app_key");
    }
}
```

### 1.2 发起广告请求
```java
// 在需要展示广告的地方
public class MainActivity extends AppCompatActivity {
    private BannerAdView bannerAdView;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        // 创建广告视图
        bannerAdView = new BannerAdView(this);
        bannerAdView.setAdSize(AdSize.BANNER);
        bannerAdView.setAdUnitId("your_ad_unit_id");
        
        // 设置广告监听器
        bannerAdView.setAdListener(new AdListener() {
            @Override
            public void onAdLoaded() {
                // 广告加载成功
            }
            
            @Override
            public void onAdFailedToLoad(LoadAdError error) {
                // 广告加载失败
            }
        });
        
        // 加载广告
        bannerAdView.loadAd();
    }
}
```

## 2. 后端向 AN 发起询价

### 2.1 后端接收请求
```javascript
// 后端 API 路由
app.post('/api/ad/request', async (req, res) => {
    const { 
        appId,
        adUnitId,
        deviceInfo,
        userInfo 
    } = req.body;
    
    // 记录请求日志
    logger.info('收到广告请求', { appId, adUnitId });
    
    // 向 AN 发起询价
    const bids = await requestBidsFromANs({
        appId,
        adUnitId,
        deviceInfo,
        userInfo
    });
    
    res.json(bids);
});
```

### 2.2 询价请求处理
```javascript
async function requestBidsFromANs(params) {
    const bids = [];
    
    // 并行向多个 AN 发起询价
    const bidPromises = [
        requestBidFromTopOn(params),
        requestBidFromMintegral(params),
        requestBidFromInMobi(params)
    ];
    
    try {
        const results = await Promise.all(bidPromises);
        bids.push(...results.filter(bid => bid !== null));
    } catch (error) {
        logger.error('AN 询价失败', error);
    }
    
    return bids;
}
```

## 3. AN 反馈询价结果

### 3.1 AN 响应处理
```javascript
async function requestBidFromTopOn(params) {
    try {
        const response = await axios.post('https://api.topon.com/bid', {
            appId: params.appId,
            adUnitId: params.adUnitId,
            deviceInfo: params.deviceInfo,
            userInfo: params.userInfo
        });
        
        if (response.data && response.data.price > 0) {
            return {
                source: 'topon',
                price: response.data.price,
                adUnitId: params.adUnitId,
                creative: response.data.creative
            };
        }
    } catch (error) {
        logger.error('TopOn 询价失败', error);
    }
    return null;
}
```

## 4. 后端进行竞价判断

### 4.1 竞价逻辑
```javascript
function determineWinningBid(bids) {
    if (!bids || bids.length === 0) {
        return null;
    }
    
    // 按价格排序
    bids.sort((a, b) => b.price - a.price);
    
    // 选择最高价
    const winningBid = bids[0];
    
    // 记录竞价结果
    logger.info('竞价结果', {
        winningSource: winningBid.source,
        winningPrice: winningBid.price,
        totalBids: bids.length
    });
    
    return winningBid;
}
```

## 5. 后端向胜出 AN 反馈

### 5.1 通知胜出 AN
```javascript
async function notifyWinningAN(winningBid) {
    try {
        const response = await axios.post(`https://api.${winningBid.source}.com/win`, {
            bidId: winningBid.bidId,
            price: winningBid.price
        });
        
        logger.info('已通知胜出 AN', {
            source: winningBid.source,
            status: response.status
        });
    } catch (error) {
        logger.error('通知胜出 AN 失败', error);
    }
}
```

## 6. 后端通知 SDK 胜出 AN

### 6.1 返回竞价结果
```javascript
app.post('/api/ad/request', async (req, res) => {
    // ... 前面的代码 ...
    
    // 确定胜出 AN
    const winningBid = determineWinningBid(bids);
    
    if (winningBid) {
        // 通知胜出 AN
        await notifyWinningAN(winningBid);
        
        // 返回结果给 SDK
        res.json({
            status: 'success',
            winningSource: winningBid.source,
            price: winningBid.price,
            creative: winningBid.creative
        });
    } else {
        res.json({
            status: 'no_bid'
        });
    }
});
```

## 7. SDK 调用 AN SDK 加载广告

### 7.1 加载广告实现
```java
public class BannerAdView extends AdView {
    @Override
    protected void loadAdWithAdapter(String source, JSONObject response) {
        switch (source) {
            case "topon":
                loadTopOnAd(response);
                break;
            case "mintegral":
                loadMintegralAd(response);
                break;
            case "inmobi":
                loadInMobiAd(response);
                break;
            default:
                Log.e(TAG, "未知的广告来源: " + source);
        }
    }
    
    private void loadTopOnAd(JSONObject response) {
        try {
            String placementId = response.getString("placementId");
            TopOnAdLoader.getInstance().loadBannerAd(
                getContext(),
                placementId,
                new TopOnAdListener() {
                    @Override
                    public void onAdLoaded(View adView) {
                        showAd(adView);
                    }
                    
                    @Override
                    public void onAdFailed(String error) {
                        Log.e(TAG, "TopOn 广告加载失败: " + error);
                    }
                }
            );
        } catch (JSONException e) {
            Log.e(TAG, "解析 TopOn 响应失败", e);
        }
    }
}
```

## 8. SDK 展示广告素材

### 8.1 广告展示实现
```java
public class BannerAdView extends AdView {
    private void showAd(View adView) {
        // 移除旧广告
        removeAllViews();
        
        // 添加新广告
        addView(adView);
        
        // 记录展示
        AdServerClient.getInstance().trackImpression(getAdUnitId());
        
        // 通知监听器
        if (adListener != null) {
            adListener.onAdLoaded();
        }
    }
    
    @Override
    public void setOnClickListener(OnClickListener listener) {
        super.setOnClickListener(v -> {
            // 记录点击
            AdServerClient.getInstance().trackClick(getAdUnitId());
            
            // 调用原始监听器
            if (listener != null) {
                listener.onClick(v);
            }
        });
    }
}
```

## 9. 完整流程示例

### 9.1 前端调用示例
```java
// 创建广告视图
BannerAdView bannerAdView = new BannerAdView(context);
bannerAdView.setAdSize(AdSize.BANNER);
bannerAdView.setAdUnitId("your_ad_unit_id");

// 设置监听器
bannerAdView.setAdListener(new AdListener() {
    @Override
    public void onAdLoaded() {
        // 广告加载成功
    }
    
    @Override
    public void onAdFailedToLoad(LoadAdError error) {
        // 广告加载失败
    }
    
    @Override
    public void onAdClicked() {
        // 广告被点击
    }
});

// 加载广告
bannerAdView.loadAd();
```

### 9.2 后端处理示例
```javascript
// 接收广告请求
app.post('/api/ad/request', async (req, res) => {
    const { appId, adUnitId, deviceInfo, userInfo } = req.body;
    
    // 1. 向 AN 发起询价
    const bids = await requestBidsFromANs({
        appId,
        adUnitId,
        deviceInfo,
        userInfo
    });
    
    // 2. 确定胜出 AN
    const winningBid = determineWinningBid(bids);
    
    if (winningBid) {
        // 3. 通知胜出 AN
        await notifyWinningAN(winningBid);
        
        // 4. 返回结果给 SDK
        res.json({
            status: 'success',
            winningSource: winningBid.source,
            price: winningBid.price,
            creative: winningBid.creative
        });
    } else {
        res.json({
            status: 'no_bid'
        });
    }
});
```

